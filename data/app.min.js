const ICONS={timer:'<svg class="status-icon" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',manual:'<svg class="status-icon" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'};async function toggleRelay(t,e,n){const o=document.getElementById("relay-"+t),a=(document.getElementById("status-"+t),o.querySelectorAll("button"));a.forEach(t=>{t.disabled=!0,t.classList.add("loading")});try{let o=`/api/relay?id=${t}&action=${e}`;n&&(o+="&duration="+60*n,localStorage.setItem("lastDurationMinutes",n));const a=await fetch(o),s=await a.json();if(s.success){if("timed"===s.mode&&s.rem>0){const e=Date.now()+1e3*s.rem;localStorage.setItem(`expire-${t}`,e)}else localStorage.removeItem(`expire-${t}`);updateRelayUI(t,s.state,s.mode,s.rem)}}catch(t){console.error("Error:",t),showToast("Failed to control relay. Please try again.")}finally{a.forEach(t=>{t.disabled=!1,t.classList.remove("loading")}),closeModal(t)}}function updateRelayUI(t,e,n,o){const a=document.getElementById("status-"+t);if(!a)return;const s="on"===e;let i="",l="";if(s)if("timed"===n){i=ICONS.timer;let e=o;if(null==e){const n=localStorage.getItem(`expire-${t}`);n&&(e=Math.max(0,Math.floor((n-Date.now())/1e3)))}e>0?l=` (${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")})`:0===e&&"timed"===n&&localStorage.removeItem(`expire-${t}`)}else i=ICONS.manual,localStorage.removeItem(`expire-${t}`);else localStorage.removeItem(`expire-${t}`);a.innerHTML=(s?"ON":"OFF")+i+l,a.className=s?"status on":"status off";const c=document.getElementById("modal-rem-"+t);c&&(c.textContent=l?`Remaining: ${l.trim()}`:"")}function showModal(t){document.getElementById("modal-"+t).style.display="flex"}function closeModal(t){document.getElementById("modal-"+t).style.display="none"}function timedRelay(t){const e=document.getElementById("duration-"+t),n=parseInt(e.value);n>0?toggleRelay(t,"timed",n):showToast("Please enter a valid duration in minutes.")}function adjustTimerDuration(t,e){const n=document.getElementById("duration-"+t);if(n){const t=Math.max(1,Math.min(20,(parseInt(n.value)||0)+e));n.value=t}}async function updateStatus(){try{const t=await fetch("/api/status"),e=await t.json();if(e.relays.forEach(t=>{if("timed"===t.mode&&t.rem>0){const e=Date.now()+1e3*t.rem;localStorage.setItem(`expire-${t.id}`,e)}updateRelayUI(t.id,t.state,t.mode,t.rem)}),e.routine){const t=null!==activeRoutineId,n=e.routine.running,o=routines.findIndex(t=>t.name===e.routine.name);if(activeRoutineId=n?o:null,t&&!n&&showToast("Routine completed!","success"),renderRoutines(),n&&-1!==o){const t=document.getElementById(`routine-status-${o}`);if(t){const n=e.routine.currentStep,o=e.routine.steps,a=o[n]?o[n].name:"?";t.innerHTML=`\n                        <div class="routine-progress">\n                            <span class="step-active">Active: ${a} (${n+1}/${e.routine.numSteps})</span>\n                            <div class="step-list-mini">\n                                ${o.map((t,e)=>`\n                                    <span class="step-dot ${e<n?"done":e===n?"busy":"todo"}" title="${t.name}"></span>\n                                `).join("")}\n                            </div>\n                        </div>\n                    `}}}}catch(t){console.error("Status update error:",t)}}let routines=[],activeRoutineId=null,stopRequested=!1,skipRequested=!1;async function fetchRoutines(){try{const t=await fetch("/api/routines");t.ok&&(routines=await t.json(),renderRoutines())}catch(t){console.error("Failed to fetch routines",t)}}function renderRoutines(){const t=document.getElementById("routines");if(t){if(t.innerHTML="",routines.length>0){const e=document.createElement("h2");e.textContent="Routines",e.style.color="#eceff1",e.style.fontSize="20px",e.style.marginBottom="15px",t.appendChild(e)}routines.forEach((e,n)=>{const o=document.createElement("div");o.className="routine-pill",activeRoutineId===n&&o.classList.add("active");const a=activeRoutineId===n;o.innerHTML=`\n            <div class="routine-pill-content" onclick="${a?"":`runRoutine(${n})`}">\n                <span class="routine-pill-name">${e.name}</span>\n                <span class="routine-pill-status" id="routine-status-${n}">\n                    ${a?"Running...":"Start"}\n                </span>\n            </div>\n            ${a?'\n                <div class="routine-pill-actions">\n                    <button class="btn-skip-routine" onclick="skipStep(event)">Skip</button>\n                    <button class="btn-stop-routine" onclick="stopActiveRoutine(event)">Stop</button>\n                </div>\n            ':""}\n        `,t.appendChild(o)})}}async function stopActiveRoutine(t){t&&t.stopPropagation();try{await fetch("/api/routine/control?action=stop"),await updateStatus()}catch(t){console.error("Failed to stop routine",t)}}async function skipStep(t){t&&t.stopPropagation();try{await fetch("/api/routine/control?action=skip"),await updateStatus()}catch(t){console.error("Failed to skip step",t)}}async function runRoutine(t){try{const e=await fetch(`/api/routine/control?action=start&index=${t}`);(await e.json()).success&&await updateStatus()}catch(t){console.error("Failed to start routine",t),showToast("Failed to start routine")}}function createRelayCards(){const t=document.getElementById("relays"),e=localStorage.getItem("lastDurationMinutes")||10;for(let n=0;n<4;n++){const o=document.createElement("div");o.className="card",o.id="relay-"+n,o.innerHTML=`\n            <div class="relay-header">\n                <span class="relay-name">${RELAY_NAMES[n]}</span>\n                <div class="status-group">\n                    <button class="btn-timer-trigger" onclick="showModal(${n})" title="Timed ON">\n                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">\n                            <circle cx="12" cy="12" r="10"></circle>\n                            <polyline points="12 6 12 12 16 14"></polyline>\n                        </svg>\n                    </button>\n                    <span class="status off" id="status-${n}">OFF</span>\n                </div>\n            </div>\n            <div class="btn-group">\n                <button class="btn-on" onclick="toggleRelay(${n}, 'on')">Turn On</button>\n                <button class="btn-off" onclick="toggleRelay(${n}, 'off')">Turn Off</button>\n                \n            </div>\n            <div id="modal-${n}" class="modal-overlay" onclick="if(event.target===this)closeModal(${n})">\n                <div class="modal">\n                    <h3>Set Timer (min)</h3>\n                    <div class="step-name" style="margin-bottom: 10px;">${RELAY_NAMES[n]}</div>\n                    <div id="modal-rem-${n}" class="modal-remaining"></div>\n                    <div class="step-controls" style="justify-content: center; margin-bottom: 20px;">\n                        <button class="btn-step-adjust" onclick="adjustTimerDuration(${n}, -1)">-</button>\n                        <input type="number" id="duration-${n}" value="${e}" min="1" max="20" style="margin-bottom: 0; width: 60px;">\n                        <button class="btn-step-adjust" onclick="adjustTimerDuration(${n}, 1)">+</button>\n                    </div>\n                    <div class="modal-btns">\n                        <button class="btn-cancel" onclick="closeModal(${n})">Cancel</button>\n                        <button class="btn-timed" onclick="timedRelay(${n})">Start</button>\n                    </div>\n                </div>\n            </div>\n        `,t.appendChild(o)}}document.addEventListener("DOMContentLoaded",()=>{createRelayCards(),updateStatus(),fetchRoutines(),setInterval(updateStatus,1e4),setInterval(()=>{for(let t=0;t<4;t++){const e=document.getElementById("status-"+t);e&&e.classList.contains("on")&&localStorage.getItem(`expire-${t}`)&&updateRelayUI(t,"on","timed")}},1e3)});