const RELAY_NAMES=["Plants","Grass","Patio Grass","Front Lawn"],ICONS={timer:'<svg class="status-icon" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',manual:'<svg class="status-icon" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'};async function toggleRelay(e,t,n){const a=document.getElementById("relay-"+e),o=(document.getElementById("status-"+e),a.querySelectorAll("button"));o.forEach(e=>{e.disabled=!0,e.classList.add("loading")});try{let a=`/api/relay?id=${e}&action=${t}`;n&&(a+="&duration="+60*n,localStorage.setItem("lastDurationMinutes",n));const o=await fetch(a),l=await o.json();if(l.success){if("timed"===l.mode&&l.rem>0){const t=Date.now()+1e3*l.rem;localStorage.setItem(`expire-${e}`,t)}else localStorage.removeItem(`expire-${e}`);updateRelayUI(e,l.state,l.mode,l.rem)}}catch(e){console.error("Error:",e),alert("Failed to control relay. Please try again.")}finally{o.forEach(e=>{e.disabled=!1,e.classList.remove("loading")}),closeModal(e)}}function updateRelayUI(e,t,n,a){const o=document.getElementById("status-"+e);if(!o)return;const l="on"===t;let s="",i="";if(l)if("timed"===n){s=ICONS.timer;let t=a;if(null==t){const n=localStorage.getItem(`expire-${e}`);n&&(t=Math.max(0,Math.floor((n-Date.now())/1e3)))}t>0?i=` (${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")})`:0===t&&"timed"===n&&localStorage.removeItem(`expire-${e}`)}else s=ICONS.manual,localStorage.removeItem(`expire-${e}`);else localStorage.removeItem(`expire-${e}`);o.innerHTML=(l?"ON":"OFF")+s+i,o.className=l?"status on":"status off";const r=document.getElementById("modal-rem-"+e);r&&(r.textContent=i?`Remaining: ${i.trim()}`:"")}function showModal(e){document.getElementById("modal-"+e).style.display="flex"}function closeModal(e){document.getElementById("modal-"+e).style.display="none"}function timedRelay(e){const t=document.getElementById("duration-"+e).value;t>0?toggleRelay(e,"timed",t):alert("Please enter a valid duration in minutes.")}async function updateStatus(){try{const e=await fetch("/api/status");(await e.json()).relays.forEach(e=>{if("timed"===e.mode&&e.rem>0){const t=Date.now()+1e3*e.rem;localStorage.setItem(`expire-${e.id}`,t)}updateRelayUI(e.id,e.state,e.mode,e.rem)})}catch(e){console.error("Status update error:",e)}}function createRelayCards(){const e=document.getElementById("relays"),t=localStorage.getItem("lastDurationMinutes")||10;for(let n=0;n<4;n++){const a=document.createElement("div");a.className="card",a.id="relay-"+n,a.innerHTML=`\n            <div class="relay-header">\n                <span class="relay-name">${RELAY_NAMES[n]}</span>\n                <div class="status-group">\n                    <button class="btn-timer-trigger" onclick="showModal(${n})" title="Timed ON">\n                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">\n                            <circle cx="12" cy="12" r="10"></circle>\n                            <polyline points="12 6 12 12 16 14"></polyline>\n                        </svg>\n                    </button>\n                    <span class="status off" id="status-${n}">OFF</span>\n                </div>\n            </div>\n            <div class="btn-group">\n                <button class="btn-on" onclick="toggleRelay(${n}, 'on')">Turn On</button>\n                <button class="btn-off" onclick="toggleRelay(${n}, 'off')">Turn Off</button>\n                \n            </div>\n            <div id="modal-${n}" class="modal-overlay" onclick="if(event.target===this)closeModal(${n})">\n                <div class="modal">\n                    <h3>Set Timer (min)</h3>\n                    <div id="modal-rem-${n}" class="modal-remaining"></div>\n                    <input type="number" id="duration-${n}" value="${t}" min="1" max="20">\n                    <div class="modal-btns">\n                        <button class="btn-cancel" onclick="closeModal(${n})">Cancel</button>\n                        <button class="btn-timed" onclick="timedRelay(${n})">Start</button>\n                    </div>\n                </div>\n            </div>\n        `,e.appendChild(a)}}document.addEventListener("DOMContentLoaded",()=>{createRelayCards(),updateStatus(),setInterval(updateStatus,1e4),setInterval(()=>{for(let e=0;e<4;e++){const t=document.getElementById("status-"+e);t&&t.classList.contains("on")&&localStorage.getItem(`expire-${e}`)&&updateRelayUI(e,"on","timed")}},1e3)});