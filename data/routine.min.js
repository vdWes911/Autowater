let routines=[],currentRoutineIndex=-1;const ICONS={up:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>',down:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>',trash:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>'};async function fetchRoutines(){try{const e=await fetch("/api/routines");e.ok&&(routines=await e.json(),Array.isArray(routines)||(routines=[]),updateRoutineList())}catch(e){console.error("Failed to fetch routines",e),routines=[],updateRoutineList()}}function updateRoutineList(){const e=document.getElementById("routine-list"),t=e.value;e.innerHTML='<option value="">-- Select or Create Routine --</option>',routines.forEach((t,n)=>{const o=document.createElement("option");o.value=n,o.textContent=t.name,e.appendChild(o)}),e.value=t}function createNewRoutine(){const e=`Routine ${routines.length+1}`;routines.push({name:e,steps:[]}),updateRoutineList(),document.getElementById("routine-list").value=routines.length-1,loadSelectedRoutine(),setTimeout(()=>{const e=document.getElementById("routine-name");e&&(e.focus(),e.select())},10)}function deleteRoutine(){-1!==currentRoutineIndex&&confirm("Delete this routine?")&&(routines.splice(currentRoutineIndex,1),currentRoutineIndex=-1,updateRoutineList(),document.getElementById("routine-editor").style.display="none")}function loadSelectedRoutine(){const e=document.getElementById("routine-list").value;if(""===e)return document.getElementById("routine-editor").style.display="none",void(currentRoutineIndex=-1);currentRoutineIndex=parseInt(e);const t=routines[currentRoutineIndex];document.getElementById("routine-name").value=t.name,document.getElementById("routine-editor").style.display="block",renderSteps()}function renderSteps(){const e=document.getElementById("routine-steps");e.innerHTML="";const t=[...routines[currentRoutineIndex].steps].sort((e,t)=>e.order-t.order);t.forEach((n,o)=>{const r=document.createElement("div");r.className="routine-step-card",r.dataset.order=n.order,r.innerHTML=`\n            <div class="step-info">\n                <span class="step-name">${n.name}</span>\n                <div class="step-controls">\n                    <button class="btn-step-adjust" onclick="adjustDuration(${n.order}, -1)">-</button>\n                    <input type="number" value="${n.duration}" min="1" max="20" onchange="updateStepDuration(${n.order}, this.value)">\n                    <button class="btn-step-adjust" onclick="adjustDuration(${n.order}, 1)">+</button>\n                    <span>minutes</span>\n                </div>\n            </div>\n            <div class="step-actions">\n                <button class="btn-icon" onclick="moveStep(${n.order}, -1)" ${0===o?"disabled":""}>${ICONS.up}</button>\n                <button class="btn-icon" onclick="moveStep(${n.order}, 1)" ${o===t.length-1?"disabled":""}>${ICONS.down}</button>\n                <button class="btn-remove-step" onclick="removeStep(${n.order})" title="Remove Step">${ICONS.trash}</button>\n            </div>\n        `,e.appendChild(r)})}function updateStepDuration(e,t){const n=routines[currentRoutineIndex].steps.find(t=>t.order===e);if(n){const o=Math.max(1,Math.min(20,parseInt(t)||1));n.duration=o;const r=document.getElementById("routine-steps"),s=Array.from(r.querySelectorAll(".routine-step-card")).find(t=>parseInt(t.dataset.order)===e);if(s){const e=s.querySelector("input");e&&e.value!=o&&(e.value=o)}}}function adjustDuration(e,t){const n=routines[currentRoutineIndex].steps.find(t=>t.order===e);if(n){const o=Math.max(1,Math.min(20,n.duration+t));if(o!==n.duration){n.duration=o;const t=document.getElementById("routine-steps"),r=Array.from(t.querySelectorAll(".routine-step-card")).find(t=>parseInt(t.dataset.order)===e);if(r){const e=r.querySelector("input");e&&(e.value=o)}}}}function showStationPicker(){const e=document.getElementById("station-options");e.innerHTML="",RELAY_NAMES.forEach((t,n)=>{const o=document.createElement("div");o.className="station-option",o.textContent=t,o.onclick=()=>addStep(n,t),e.appendChild(o)}),document.getElementById("station-modal").style.display="flex"}function closeStationPicker(){document.getElementById("station-modal").style.display="none"}function addStep(e,t){const n=routines[currentRoutineIndex],o=n.steps.length>0?Math.max(...n.steps.map(e=>e.order))+1:0;n.steps.push({id:e,name:t,duration:5,enabled:!0,order:o}),closeStationPicker(),renderSteps()}function removeStep(e){const t=routines[currentRoutineIndex],n=t.steps.findIndex(t=>t.order===e);-1!==n&&(t.steps.splice(n,1),t.steps.sort((e,t)=>e.order-t.order).forEach((e,t)=>e.order=t),renderSteps())}function updateStep(e,t,n){const o=routines[currentRoutineIndex].steps.find(t=>t.order===e);"duration"===t&&(n=parseInt(n)),o[t]=n}async function moveStep(e,t){const n=routines[currentRoutineIndex].steps,o=n.findIndex(t=>t.order===e),r=e+t,s=n.findIndex(e=>e.order===r);if(-1!==s){const e=document.getElementById("routine-steps"),t=Array.from(e.querySelectorAll(".routine-step-card")).map(e=>({el:e,order:parseInt(e.dataset.order),rect:e.getBoundingClientRect()})),r=n[o].order;n[o].order=n[s].order,n[s].order=r,n.sort((e,t)=>e.order-t.order),renderSteps(),Array.from(e.querySelectorAll(".routine-step-card")).forEach(e=>{const n=parseInt(e.dataset.order),o=t.find(e=>e.order===n);if(o){const t=e.getBoundingClientRect(),n=o.rect.top-t.top;0!==n&&(e.style.transition="none",e.style.transform=`translateY(${n}px)`,e.offsetHeight,requestAnimationFrame(()=>{e.style.transition="transform 0.4s cubic-bezier(0.2, 0, 0, 1)",e.style.transform="",e.classList.add("moving"),setTimeout(()=>{e.style.transition="",e.classList.remove("moving")},400)}))}})}}async function saveRoutines(){routines[currentRoutineIndex].name=document.getElementById("routine-name").value,updateRoutineList();try{const e=await fetch("/api/routines",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(routines)});e.ok?showToast("Routines saved","success"):showToast("Failed to save routines, error was: "+e.statusText)}catch(e){showToast("Error saving routines: "+e.message)}}document.addEventListener("DOMContentLoaded",fetchRoutines);